{% extends 'viewer/viewer_base.html' %}

{% load staticfiles %}

{% block content_child %}
    <div class="row position-data">
        <input id="position-data-carrier-id" placeholder="Input carrier id"/>
        <input id="position-data-count" placeholder="Input count of coordinates to build"/>
        <button class="button btn-small waves-effect position-data-control-btn" id="build-route">Build route</button>
        <button class="button btn-small waves-effect position-data-control-btn" id="clear-route">Clear route</button>
        <p id="position-data-info"></p>
    </div>
{% endblock %}

{% block script_block_child %}
    <script>
        const mapZoomRoute = 15;
        const ws_path = "/ws/route/";
        const ws = new WebSocket("ws://" + window.location.host + ws_path);

        let position_data_info = document.getElementById('position-data-info');

        let routes = [];

        ws.onmessage = function (message) {
            position_data_info.innerText = "";

            let parsedMessage = JSON.parse(message.data);

            if (parsedMessage.error) {
                position_data_info.innerText = parsedMessage.error;

                return;
            }

            if (!parsedMessage.coordinates) {
                position_data_info.innerText = "Some data don't exist. Server error";

                return;
            }

            let coordinates = parsedMessage.coordinates;
            let firstCoordinate = coordinates[0];

            googleMap.setCenter(firstCoordinate);
            googleMap.setZoom(mapZoomRoute);

            route = new google.maps.Polyline({
                path: coordinates,
                strokeWeight: 2,
                strokeOpacity: 1.0,
                strokeColor: '#FF0000',
                geodesic: 2
            });

            route.setMap(googleMap);

            routes.push(route);
        };

        $('#build-route').click(function (e) {
            let carrier_id = document.getElementById('position-data-carrier-id').value;
            let count_of_coordinates = document.getElementById('position-data-count').value;

            if (carrier_id === "" || isNaN(carrier_id) || count_of_coordinates === ""
                || isNaN(count_of_coordinates)) {

                position_data_info.innerText = "Please, fill all inputs and check " +
                    "if values are digits";

                return;
            }

            ws.send(JSON.stringify({
                "carrier_id": carrier_id,
                "count_of_coordinates": count_of_coordinates
            }));
        });

        $('#clear-route').click(function (e) {
            for (route of routes) {
                route.setMap(null);
            }

            routes = [];
        });
    </script>
{% endblock %}